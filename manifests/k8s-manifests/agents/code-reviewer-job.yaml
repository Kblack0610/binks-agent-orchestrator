apiVersion: batch/v1
kind: Job
metadata:
  name: code-reviewer-agent
  namespace: ai-agents
  labels:
    agent-type: code-reviewer
    spawned-by: binks-orchestrator
spec:
  backoffLimit: 2
  ttlSecondsAfterFinished: 3600  # Clean up 1 hour after completion
  template:
    metadata:
      labels:
        agent-type: code-reviewer
    spec:
      restartPolicy: OnFailure
      containers:
      - name: code-reviewer
        image: python:3.11-slim
        command: ["/bin/bash"]
        args:
          - -c
          - |
            # Install dependencies
            pip install --no-cache-dir agno requests

            # Run the code reviewer agent
            python /app/code_reviewer_agent.py
        env:
        - name: OLLAMA_API_URL
          value: "http://ollama-service.ai-services.svc.cluster.local:11434"
        - name: TASK_ID
          value: "{{ TASK_ID }}"  # Template variable - replaced by orchestrator
        - name: REPO_URL
          value: "{{ REPO_URL }}"  # Template variable
        volumeMounts:
        - name: agent-script
          mountPath: /app
      volumes:
      - name: agent-script
        configMap:
          name: code-reviewer-agent-script
---
# ConfigMap containing the agent script
apiVersion: v1
kind: ConfigMap
metadata:
  name: code-reviewer-agent-script
  namespace: ai-agents
data:
  code_reviewer_agent.py: |
    #!/usr/bin/env python3
    """
    Code Reviewer Worker Agent
    This agent is spawned by the M3 Orchestrator to review code changes.
    Uses Agno for lightweight execution on Pi cluster.
    """
    import os
    from agno.agent import Agent
    from agno.models.ollama import Ollama

    # Get configuration from environment
    ollama_url = os.getenv('OLLAMA_API_URL')
    task_id = os.getenv('TASK_ID')
    repo_url = os.getenv('REPO_URL')

    print(f"Code Reviewer Agent starting...")
    print(f"Task ID: {task_id}")
    print(f"Repo URL: {repo_url}")

    # Create the agent with Ollama
    reviewer = Agent(
        name="CodeReviewer",
        model=Ollama(id="llama3.1:8b", host=ollama_url),
        instructions=[
            "You are an expert code reviewer focused on quality and best practices.",
            f"Review the code changes in {repo_url}",
            "Focus on: code quality, potential bugs, security issues, and improvements",
        ],
        markdown=True
    )

    # Execute the review task
    task = f"Clone {repo_url}, review recent changes, and provide feedback."
    result = reviewer.run(task)

    print("\n=== Code Review Complete ===")
    print(result.content if hasattr(result, 'content') else str(result))

    # In a real setup, you'd send results back to the orchestrator
    # e.g., via an API call or message queue
